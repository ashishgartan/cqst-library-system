<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configurations | CQST Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap");
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background-color: #f8fafc;
      }
      .content-card {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      }
      input:focus {
        border-color: #ef4444 !important;
        background-color: white !important;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.05) !important;
      }
    </style>
  </head>

  <body class="text-slate-700 min-h-screen flex flex-col">
    <%- include('partials/header') %>

    <main class="flex-1 max-w-4xl mx-auto p-6 md:p-12 w-full">
      <div class="mb-10 flex items-center justify-between">
        <div>
          <h1
            class="text-3xl font-black text-slate-900 tracking-tight flex items-center gap-3"
          >
            <i data-lucide="settings-2" class="text-red-600 w-8 h-8"></i>
            Library Configurations
          </h1>
          <p
            class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-2 ml-1"
          >
            Global Rules & Policy Management
          </p>
        </div>
      </div>

      <form
        id="settingsForm"
        class="content-card rounded-[2.5rem] overflow-hidden border-none shadow-xl"
      >
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-slate-50 border-b border-slate-100">
              <th
                class="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]"
              >
                Configuration Rule
              </th>
              <th
                class="px-8 py-6 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] text-right"
              >
                Current Setting
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            <tr class="hover:bg-slate-50/50 transition-colors">
              <td class="px-8 py-8">
                <div class="flex items-start gap-4">
                  <div class="mt-1 p-2 bg-red-50 rounded-lg text-red-600">
                    <i data-lucide="banknote" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <p
                      class="text-slate-900 font-black text-sm uppercase tracking-tight"
                    >
                      Fine Per Day (â‚¹)
                    </p>
                    <p
                      class="text-[11px] text-slate-400 font-medium mt-1 leading-relaxed"
                    >
                      The automated daily penalty amount charged for overdue
                      books.
                    </p>
                  </div>
                </div>
              </td>
              <td class="px-8 py-8">
                <input
                  type="number"
                  name="fine_per_day"
                  value="<%= settings.fine_per_day %>"
                  required
                  class="ml-auto block w-28 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-900 font-black text-right outline-none transition-all"
                />
              </td>
            </tr>

            <tr class="hover:bg-slate-50/50 transition-colors">
              <td class="px-8 py-8">
                <div class="flex items-start gap-4">
                  <div class="mt-1 p-2 bg-slate-100 rounded-lg text-slate-600">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <p
                      class="text-slate-900 font-black text-sm uppercase tracking-tight"
                    >
                      Borrow Days Limit
                    </p>
                    <p
                      class="text-[11px] text-slate-400 font-medium mt-1 leading-relaxed"
                    >
                      The standard duration (in days) a student is permitted to
                      keep a resource.
                    </p>
                  </div>
                </div>
              </td>
              <td class="px-8 py-8">
                <input
                  type="number"
                  name="borrow_days_limit"
                  value="<%= settings.borrow_days_limit %>"
                  required
                  class="ml-auto block w-28 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-900 font-black text-right outline-none transition-all"
                />
              </td>
            </tr>

            <tr class="hover:bg-slate-50/50 transition-colors">
              <td class="px-8 py-8">
                <div class="flex items-start gap-4">
                  <div class="mt-1 p-2 bg-slate-100 rounded-lg text-slate-600">
                    <i data-lucide="layers" class="w-5 h-5"></i>
                  </div>
                  <div>
                    <p
                      class="text-slate-900 font-black text-sm uppercase tracking-tight"
                    >
                      Max Books Per Student
                    </p>
                    <p
                      class="text-[11px] text-slate-400 font-medium mt-1 leading-relaxed"
                    >
                      Upper limit of active concurrent loans allowed per
                      borrower.
                    </p>
                  </div>
                </div>
              </td>
              <td class="px-8 py-8">
                <input
                  type="number"
                  name="max_books_per_student"
                  value="<%= settings.max_books_per_student %>"
                  required
                  class="ml-auto block w-28 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-900 font-black text-right outline-none transition-all"
                />
              </td>
            </tr>
          </tbody>
        </table>

        <div
          class="bg-slate-50 p-8 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <div class="flex items-center gap-3 text-slate-400">
            <i data-lucide="info" class="w-4 h-4"></i>
            <p class="text-[10px] font-bold uppercase tracking-widest">
              Changes will apply to all future transactions immediately.
            </p>
          </div>
          <button
            type="submit"
            id="saveBtn"
            class="w-full md:w-auto bg-slate-900 hover:bg-red-600 text-white font-black py-4 px-12 rounded-2xl transition-all shadow-xl shadow-slate-200 active:scale-95 uppercase tracking-[0.2em] text-xs flex items-center justify-center gap-3"
          >
            Update Policy
            <i data-lucide="save" class="w-4 h-4"></i>
          </button>
        </div>
      </form>
    </main>

    <%- include('partials/footer') %>

    <script>
      lucide.createIcons();

      document
        .getElementById("settingsForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = document.getElementById("saveBtn");
          const originalHTML = btn.innerHTML;

          btn.disabled = true;
          btn.innerHTML =
            '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Processing...';
          lucide.createIcons();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());

          try {
            const res = await fetch("/settings/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            if (res.ok) {
              btn.classList.replace("bg-slate-900", "bg-green-600");
              btn.innerHTML =
                '<i data-lucide="check" class="w-4 h-4"></i> Settings Saved';
              lucide.createIcons();

              setTimeout(() => {
                btn.classList.replace("bg-green-600", "bg-slate-900");
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                lucide.createIcons();
              }, 3000);
            } else {
              throw new Error();
            }
          } catch (err) {
            alert("Security Error: Failed to update global settings.");
            btn.disabled = false;
            btn.innerHTML = originalHTML;
            lucide.createIcons();
          }
        });
    </script>
  </body>
</html>
